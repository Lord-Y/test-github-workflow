name: Create Release

# tags matching pattern can be found here:
# https://docs.github.com/en/actions/reference/workflows-and-actions/workflow-syntax#filter-pattern-cheat-sheet
on:
  push:
    tags:
      - 'v[0-9]+\.[0-9]+\.[0-9]+-*'
      - 'v[0-9]+\.[0-9]+\.[0-9]+'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go:
          - "1.25.3"

    steps:
      - name: Set up Go environment
        uses: actions/setup-go@v6
        with:
          go-version: ${{ matrix.go }}

      - name: Print env variables
        run: |
          go version
          env

      - name: Publish release
        run: |
          go install github.com/github-release/github-release@latest
          PRE_RELEASE_RE="^v[0-9]+\.[0-9]+\.[0-9]+-(.*)$"
          GITHUB_REPOSITORY_NAME=${GITHUB_REPOSITORY##*/}
          find changelog

          if [[ "${GITHUB_REF_NAME}" =~ ${PRE_RELEASE_RE} ]]
          then
            MD_RELEASE_FILE="${GITHUB_REF_NAME%-*}"
            github-release release \
            --pre-release \
            --security-token "${{ secrets.RELEASE_TOKEN }}" \
            --tag "${GITHUB_REF_NAME}" \
            --user "${GITHUB_REPOSITORY_OWNER}" \
            --repo "${GITHUB_REPOSITORY_NAME}" \
            --target "${GITHUB_SHA}" \
            --description "$(cat ${GITHUB_WORKSPACE}/changelog/${MD_RELEASE_FILE}.md)"
          else
            github-release release \
            --security-token "${{ secrets.RELEASE_TOKEN }}" \
            --tag "${GITHUB_REF_NAME}" \
            --user "${GITHUB_REPOSITORY_OWNER}" \
            --repo "${GITHUB_REPOSITORY_NAME}" \
            --target "${GITHUB_SHA}" \
            --description "$(cat ${GITHUB_WORKSPACE}/changelog/${GITHUB_REF_NAME}.md)"
          fi
